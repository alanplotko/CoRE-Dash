<!doctype html>
<html class="no-js" lang="en">
  <head>
    
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-signin-clientid" content="615316435724-k7gu8chlmqc3gkuru56bamcr4f9pv7sm.apps.googleusercontent.com" />
    <meta name="google-signin-scope" content="https://www.googleapis.com/auth/plus.login profile email" />
    <meta name="google-signin-requestvisibleactions" content="http://schema.org/AddAction" />
    <meta name="google-signin-cookiepolicy" content="single_host_origin" />
    <meta name="google-signin-callback" content="onSignInCallback" />
    
    <title>CoRE Manager</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/foundation.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/style.css') }}" />
    <link href="http://fonts.googleapis.com/css?family=Roboto:100,400" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='assets/favicon.ico') }}" />
    
    <script src="{{ url_for('static', filename='assets/js/vendor/modernizr.js') }}"></script>
    <script src="https://apis.google.com/js/client:platform.js?onload=render" async defer>
      /* Executed when the APIs finish loading */
      function render() {
        gapi.signin.render('g-signin', {
          'theme': 'dark'
        });
      }
    </script>
  </head>
  <body>
    
    <div class="row">
      <div id="content" class="large-12 columns">
        <h1 id="welcome">CoRE Manager</h1>
        <div class="g-signin">&nbsp;</div>
        <div id="userInfo"></div>
        <button id="disconnect" class="button alert" style="display:none;">Disconnect your Google account from this app</button>
        <div id="loaderror"></div>
      </div>
    </div>
    
    <script src="{{ url_for('static', filename='assets/js/vendor/jquery.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/foundation.min.js') }}"></script>
    <script>
      $(document).foundation();

      var helper = (function() {
        var BASE_API_PATH = 'plus/v1/';

        return {
          onSignInCallback: function(authResult) {
            gapi.client.load('plus','v1').then(function() {
              if (authResult['access_token']) {
                $('#content').fadeOut('slow', function() {
                  $('.g-signin').hide();
                  $('#welcome').empty();
                  $.when(helper.profile()).then(function()
                  {
                    $('#content').fadeIn('slow');
                  });
                });
              } else if (authResult['error']) {
                $('#button.g-signin').show();
              }
            });
          },

          profile: function(){
            gapi.client.plus.people.get({
              'userId': 'me'
            }).then(function(res) {
              console.log('res', res);
              $('#disconnect').show();
              
              var profile = res.result;
              $('#welcome').text("Welcome back, " + profile.displayName + '!');
              
              var primaryEmail;
              for (var i=0; i < profile.emails.length; i++) {
                if (profile.emails[i].type === 'account') primaryEmail = profile.emails[i].value;
              }
              
              $("#userInfo").append('<p>Primary email: ' + primaryEmail + '</p>');
              $("#content").css('margin-top', (-1 * $("#content").height()/2) + 'px');
            }, function(err) {
              var error = err.result;
              $('#userInfo').empty();
              $('#userInfo').append(error.message);
            });
          },

          disconnect: function() {
            // Revoke the access token.
            $.ajax({
              type: 'GET',
              url: 'https://accounts.google.com/o/oauth2/revoke?token=' + gapi.auth.getToken().access_token,
              async: false,
              contentType: 'application/json',
              dataType: 'jsonp',
              success: function(result) {
                location.reload();
              }
            });
          }
        };
      })();

      $(document).ready(function() {
        $('#disconnect').click(helper.disconnect);
        $('#loaderror').hide();
      });

      function onSignInCallback(authResult) {
        helper.onSignInCallback(authResult);
      }
    </script>
  </body>
</html>
